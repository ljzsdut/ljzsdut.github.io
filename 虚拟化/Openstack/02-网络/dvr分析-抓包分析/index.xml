<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ljzsdut</title><link>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</link><description>Recent content on ljzsdut</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/index.xml" rel="self" type="application/rss+xml"/><item><title/><link>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/01-floatingIP%E4%B8%8E%E5%A4%96%E7%BD%91%E4%BA%92%E8%AE%BF%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/01-floatingIP%E4%B8%8E%E5%A4%96%E7%BD%91%E4%BA%92%E8%AE%BF%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</guid><description>过程简述：
首先要知道，fip是配置在qrouter上的iptables规则，并不存在任一个网卡上。
访问外网：报文从VM(二层转发)发送到网关qrouter上，qrouter进行snat转换成fip，并通过路由表到达fip名称空间中，查询fip中的路由表，发送至floating-gw。
返程：floating-gw上的报文通过arp fip，fg开启arp代理后代为应答，报文到达fip上，通过路由表达到qrouter上，进行snat地址还原后，通过路由表发送至qr口，而后二层转发达到VM.
设备名称：
tap设备=tap${VM_PORT_ID:0:11}
qrouter名称空间：qrouter-${ROUTER_ID}
snat名称空间：snat-${ROUTER_ID}
NIC_qrouter_rfp: rfp-${ROUTER_ID:0:11}，所以qrouter下只有一个rfp口，但其上有多个IP。rfp口用于连接fip名称空间。（qr口有多个，每个子网一个qr口）
NIC_fip_fpr: fpr-${ROUTER_ID:0:11}，因为每个compute节点上只有1个fip名称空间，用于连接该节点上所有的qrouter，所以fip名称空间下有多个fpr-${ROUTER_ID:0:11}接口，用于连接不同的qrouter。通过fpr口的id就能知道其连接哪个qrouter
qrouter里的qr口：qr-${子网默认网关对应port_ID:0:11}，port的device_owner为“network:router_interface_distributed”，该port与子网是1:1。
fip名称空间： fip-${floating网络networkID}，id为floating网络的ID，所以不同计算节点上都只有1个fip名称空间，而且其ID是相同的。
NIC_fip_fg: fg-${PORT_ID:0:11} port的device_owner为“network:floatingip_agent_gateway”，每个计算节点占用一个floating网的IP。
NIC_snat_sg: sg-${PORT_ID:0:11} port的device_owner为“network:router_centralized_snat”，该port与子网是1:1。
NIC_snat_qg: qg-${PORT_ID:0:11} port的device_owner为“network:router_gateway”，该port与network/router是1:1或n:1。n:1是指为router指定多个外部网关。
qdhcp-${networkID}
路由器上的3类port：
router_interface_distributed：分布式路由器的接口，路由器上普通的接口即子网的网关接口 router_centralized_snat：路由器上集中snat的接口，为没有fip的虚机提供snat转换，与子网是1:1的关系 router_gateway：路由器上连接外网网络的接口，即路由器上的网关接口，一般一个路由器只有1个。（注意区分“路由器网关”与“路由器接口(子网网关)”） network:router_interface_distributed ：表示路由器上的普通接口（子网的默认网关所在的接口） network:dhcp ：表示 network:router_centralized_snat ：表示路由器上连接snat名称空间的port，每个子网占用一个port，其IP配置在snat名称空间的sg口 network:floatingip ：floatingip所在的port，其IP在qrouter的iptables上 network:floatingip_agent_gateway ：fip的节点代理端口，fip名称空间下fg口的ip所在的port，每个compute节点占用一个port network:router_gateway ：路由器上的外部网关port。IP在snat名称空间的qg口 snat里的sg口和qg口通过如下sql获取：
SELECT id FROM `neutron`.`ports` WHERE `device_id` = &amp;#39;3682faea-db63-44ee-8638-4fbc53c8956f&amp;#39; -- ROUTER_ID -- AND `device_owner` = &amp;#39;network:router_gateway&amp;#39;; -- NIC_snat_qg snat名称空间下的qg口 -- AND `device_owner` = &amp;#39;network:router_centralized_snat&amp;#39;; -- NIC_snat_sg 通过FloatingIP访问外网 #虚拟机内ping (192.</description></item><item><title/><link>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/02-%E6%97%A0floatingIP%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91vm%E8%AE%BF%E9%97%AEservice-data%E7%BD%91%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/02-%E6%97%A0floatingIP%E8%AE%BF%E9%97%AE%E5%A4%96%E7%BD%91vm%E8%AE%BF%E9%97%AEservice-data%E7%BD%91%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/</guid><description>概述 关于接口/port的一些知识点：
1、tap、qbr、qvo、qvb的id是一致的。
2、每个子网在qrouter上对应1个qr口。qrouter上所有子网共用1个rfp和fpr口。每个子网对应snat-ns上的1个sg口，共用一个qg口。
3、每个router在fip上对应1个fpr口。所有的qrouter共用1个fip-ns。所有router共用1个fg口。
过程简述：
首先要知道：snat发生在snat名称空间下，会将源IP替换为floating网内的某个IP。
访问外网：报文从VM(二层转发)发送到网关qrouter上，qrouter内部通过匹配规则(ip rule)路由发送到snat名称空间的sg口，snat内部先做snat地址转换，然后匹配路由表通过qg口二层转发到floating-gw。
返程：
通过二层转发到snat名称空间下的qg口，snat内部先还原snat转换，然后通过sg口二层转发到VM。
其他：
没有fip的情况，流量必须通过network节点的SNAT转发。network对应的snat名称空间在3个网络节点上的其中一个，随机分配。
流量到达snat名称空间后，会发生SNAT源地址转换。
说明：
新版的安全组采用ovs实现，所以上图中的qbr桥在新版中不存在。eth0对应的tap设备直接插入到br-int桥上。此时，整个系统不再出现linux bridge设备。
介绍：https://www.jianshu.com/p/6fb4072cea5d
虚机信息 ssh -i zdy/id_rsa 100.123.7.189
root@mgt01:~# openstack server list --all --long |grep 100.123.7.189 | cb1ea17d-c142-43ca-a718-705984bc96fa | ies-20210817163009-manager-0 | ACTIVE | None | Running | Default-vpc-1=172.31.2.130; service_mgt=100.123.7.189 | N/A (booted from volume) | N/A (booted from volume) | ies_4C8G100G_general | c184a73d-2578-499e-8007-de70c0f23e1e | az-native-test | compute01 | this=&amp;#39;IES&amp;#39; #获取到如下信息： 物理机：compute01 ID： cb1ea17d-c142-43ca-a718-705984bc96fa #经过查询，获取到路由器和snat（都是routerid）： qrouter-351b7ee3-0e4d-47e6-8c3b-44f059e44f12 （位于compute01节点，准确说每个计算节点和network节点都有） snat-351b7ee3-0e4d-47e6-8c3b-44f059e44f12 （位于network节点） #因tap设备上的id为port_id的前11位，所以要找到tap设备，必须先找到port ID。 root@mgt01:~# openstack port list --server cb1ea17d-c142-43ca-a718-705984bc96fa |grep 172.</description></item><item><title/><link>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/03-%E5%90%8C%E8%8A%82%E7%82%B9%E4%B8%9C%E8%A5%BF%E5%90%91%E8%B7%A8%E5%AD%90%E7%BD%91/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/03-%E5%90%8C%E8%8A%82%E7%82%B9%E4%B8%9C%E8%A5%BF%E5%90%91%E8%B7%A8%E5%AD%90%E7%BD%91/</guid><description/></item><item><title/><link>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/04-%E4%B8%8D%E5%90%8C%E8%8A%82%E7%82%B9%E4%B8%9C%E8%A5%BF%E5%90%91%E8%B7%A8%E5%AD%90%E7%BD%91/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/04-%E4%B8%8D%E5%90%8C%E8%8A%82%E7%82%B9%E4%B8%9C%E8%A5%BF%E5%90%91%E8%B7%A8%E5%AD%90%E7%BD%91/</guid><description/></item><item><title/><link>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/05-%E5%90%8C%E5%AD%90%E7%BD%91%E4%B8%9C%E8%A5%BF%E5%90%91/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://note.ljzsdut.com/%E8%99%9A%E6%8B%9F%E5%8C%96/Openstack/02-%E7%BD%91%E7%BB%9C/dvr%E5%88%86%E6%9E%90-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90/05-%E5%90%8C%E5%AD%90%E7%BD%91%E4%B8%9C%E8%A5%BF%E5%90%91/</guid><description>对于同子网，无论是否是同节点还是跨节点，流量都是通过br-int桥或br-tun桥实现二层通信。</description></item></channel></rss>